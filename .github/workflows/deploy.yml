name: Build and Deploy to Hostinger

on:
  push:
    branches:
      - master

env:
  JAVA_VERSION: '17'
  HOSTINGER_USER: appuser
  HOSTINGER_HOST: 147.93.84.18
  HOSTINGER_PATH: /opt/applications/java
  HOSTINGER_SSH_KEY: ssh-rsa AAAAB3NzaC1yc2EAAAADAQABAAABgQC3Nn3WRyLrtayLX8o2PDYevheK2qJSv4KbiaR7mZ8YEJvdWxkrzo4J18z9r3EIpfUG4zGnDt4pAWpVnlzrRt0r/wgJUh2on3q0O0Hk3j61EikdddzO56sjiOYk2kLFx9WsP+GSL6V7M+ClOeIckm674ZA2blt628llJKSxsJpp/883WnDxJL+kOvrnoKnIp41chjsusjoZgb7I2XRUvPCpZ5Xx1t24yt827uka6IMgrqxhx7EFhAN5Xh795tDSRktv35tHah/M0TVn1ussxb/28zCcw4Tfos2pSZIOUlvbw4N1J8jCYSJugexnMKM7bB7hVA/z903M6Pwg1pFhaCA4iH7msnoFX1LGAi2imG2Qq6DK/hhBSA0ZGGxaI7IKY+f3jfh86bUZDJ2DGoj70koD5FBCiqJmKQnfpCMmZ+rSy8vwQ0KkNqjAvUAsPOuoRFvIojBJ9/+qvhmWhoaE/RBF7F50BFq9MU2Bp79HNvvoKeD/+ImaA72T1aeZmUV64js= ranjanstartupidea@gmail.com


jobs:
  build:
    runs-on: ubuntu-20.04

    steps:
      - name: Checkout Repository
        uses: actions/checkout@v3

      - name: Set up JDK ${{ env.JAVA_VERSION }}
        uses: actions/setup-java@v3
        with:
          java-version: ${{ env.JAVA_VERSION }}
          distribution: 'temurin'

      - name: Build with Maven
        run: mvn clean package -DskipTests

      - name: Upload JAR artifact
        uses: actions/upload-artifact@v4
        with:
          name: eureka-server
          path: target/*.jar

  deploy:
    needs: build
    runs-on: ubuntu-20.04

    steps:
      - name: Checkout Repository
        uses: actions/checkout@v3

      - name: Download JAR artifact
        uses: actions/download-artifact@v4
        with:
          name: eureka-server
          path: target/

      - name: Setup SSH Key
        run: |
          mkdir -p ~/.ssh/
          echo "${{ HOSTINGER_SSH_KEY }}" > ~/.ssh/id_rsa
          chmod 600 ~/.ssh/id_rsa
          ssh-keyscan -H ${{ HOSTINGER_HOST }} >> ~/.ssh/known_hosts

      - name: Deploy to Hostinger
        run: |
          echo "Deploying the service on host ${{ HOSTINGER_USER }}"
          scp target/*.jar ${{ HOSTINGER_USER }}@${{ HOSTINGER_HOST }}:${{ HOSTINGER_PATH }}/app.jar
          ssh ${{ HOSTINGER_USER }}@${{ HOSTINGER_HOST }} "bash -s" << 'EOF'
            pkill -f 'java -jar'
            nohup java -jar ${{ HOSTINGER_PATH }}/app.jar > app.log 2>&1 &
          EOF
